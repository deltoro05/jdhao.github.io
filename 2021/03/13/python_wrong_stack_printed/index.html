<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Why is Wrong Stacktrace Printed for My Code? - jdhao's digital space</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="jdhao"><meta name=description content="The other day, when I was updating the source code with the project running, I noticed that the exception stack trace printed is not right, i.e., the printed error line is actually not the line that is triggering the exception.
"><meta name=keywords content="Hugo,theme,even"><meta name=google-site-verification content="HTz0VHxqny_b0FfS774dICLBzHGBZCb_S11j_akF1Tw"><meta name=generator content="Hugo 0.123.8 with theme even"><link rel=canonical href=https://jdhao.github.io/2021/03/13/python_wrong_stack_printed/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6058871559165202",enable_page_level_ads:!0})</script><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Why is Wrong Stacktrace Printed for My Code?"><meta property="og:description" content="The other day, when I was updating the source code with the project running, I
noticed that the exception stack trace printed is not right, i.e., the printed
error line is actually not the line that is triggering the exception."><meta property="og:type" content="article"><meta property="og:url" content="https://jdhao.github.io/2021/03/13/python_wrong_stack_printed/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-03-13T21:02:47+08:00"><meta property="article:modified_time" content="2021-03-15T15:00:39+01:00"><meta itemprop=name content="Why is Wrong Stacktrace Printed for My Code?"><meta itemprop=description content="The other day, when I was updating the source code with the project running, I
noticed that the exception stack trace printed is not right, i.e., the printed
error line is actually not the line that is triggering the exception."><meta itemprop=datePublished content="2021-03-13T21:02:47+08:00"><meta itemprop=dateModified content="2021-03-15T15:00:39+01:00"><meta itemprop=wordCount content="531"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Why is Wrong Stacktrace Printed for My Code?"><meta name=twitter:description content="The other day, when I was updating the source code with the project running, I
noticed that the exception stack trace printed is not right, i.e., the printed
error line is actually not the line that is triggering the exception."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>jdhao's digital space</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>jdhao's digital space</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Why is Wrong Stacktrace Printed for My Code?</h1><div class=post-meta><span class=post-time>2021-03-13</span><div class=post-category><a href=/categories/Python/>Python</a></div><span class=more-meta>531 words </span><span class=more-meta>3 mins read </span><span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p>The other day, when I was updating the source code with the project running, I
noticed that the exception stack trace printed is not right, i.e., the printed
error line is actually not the line that is triggering the exception.</p><p>Why did this happen? Is it related to the modification to the source file? At
first, I thought it absurd. Based on my knowledge, when Python runs the source
code, it will load it into memory. Since it is executing the code in the memory,
so it <em>should</em> print the offending line that is kept in the memory.</p><p>To figure it out, I write the following code (<code>test.py</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>I run it (<code>python test.py</code>), then add something below the time statement:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># some comment</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>Then program reaches the print statement and printed the following exception:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Traceback (most recent call last):
</span></span><span class=line><span class=cl>  File &#34;test.py&#34;, line 4, in &lt;module&gt;
</span></span><span class=line><span class=cl>    # some comment
</span></span><span class=line><span class=cl>ZeroDivisionError: division by zero
</span></span></code></pre></div><p>Surprisingly, the stack trace printed is the 4th line in the modified <code>test.py</code>,
not the original 4th line (<code>print(1/0)</code>).</p><p>So my perception of how Python runs its code is not fully correct. I searched
on the internet and found some explanation about this, for example, discussion
<a href=https://stackoverflow.com/a/43594452/6064933>here</a>.</p><p>When Python run a source code, it will first compile the source code into the
so called <a href=https://docs.python.org/3/glossary.html#term-bytecode>bytecode</a>.
Then the bytecode is executed by the <a href=https://docs.python.org/3/glossary.html#term-virtual-machine>Python virtual machine</a>.</p><p>So what is really running is the bytecode, not the original source code. We can
use the <code>dis</code> package in standard library to inspect the bytecode produced by
Python.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>my_str</span> <span class=o>=</span> <span class=s2>&#34;import time</span><span class=se>\n\n</span><span class=s2>time.sleep(10)</span><span class=se>\n</span><span class=s2>print(1/0)&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>my_str</span><span class=p>))</span>
</span></span></code></pre></div><p>It will show the bytecode along with other infos for the source code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>│  1           0 LOAD_CONST               0 (0)
</span></span><span class=line><span class=cl>│              2 LOAD_CONST               1 (None)
</span></span><span class=line><span class=cl>│              4 IMPORT_NAME              0 (time)
</span></span><span class=line><span class=cl>│              6 STORE_NAME               0 (time)
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>│  3           8 LOAD_NAME                0 (time)
</span></span><span class=line><span class=cl>│             10 LOAD_METHOD              1 (sleep)
</span></span><span class=line><span class=cl>│             12 LOAD_CONST               2 (10)
</span></span><span class=line><span class=cl>│             14 CALL_METHOD              1
</span></span><span class=line><span class=cl>│             16 POP_TOP
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>│  4          18 LOAD_NAME                2 (print)
</span></span><span class=line><span class=cl>│             20 LOAD_CONST               3 (1)
</span></span><span class=line><span class=cl>│             22 LOAD_CONST               0 (0)
</span></span><span class=line><span class=cl>│             24 BINARY_TRUE_DIVIDE
</span></span><span class=line><span class=cl>│             26 CALL_FUNCTION            1
</span></span><span class=line><span class=cl>│             28 POP_TOP
</span></span><span class=line><span class=cl>│             30 LOAD_CONST               1 (None)
</span></span><span class=line><span class=cl>│             32 RETURN_VALUE
</span></span></code></pre></div><p>Number in the first column corresponds to the code line in the original script.
For example, the first line (<code>import time</code>) is turned into 4 bytecode
instructions.</p><p>As a result, the original source code is not kept by Python in the memory. When
an exception happens, python will try to find the corresponding source file and
print the exact line in this source file. It does not check whether the source
file has been changed since running. Hence, the mismatch between the printed
exception line and the actual exception line.</p><p>So this is just how Python works under the hood. There are <a href=https://bugs.python.org/issue8087>discussion</a> on
changing this behaviour, but it seems that the Python core developers are not
going to change it any time soon.</p><h1 id=references>References</h1><ul><li><a href=https://stackoverflow.com/q/55492150/6064933>Why does error traceback show edited script instead of what actually ran?</a></li><li><a href=https://stackoverflow.com/q/5296977/6064933>What will happen if I modify a Python script while it&rsquo;s running?</a></li><li>See CPython run: Getting to know your Python interpreter: <a href="https://www.youtube.com/watch?v=tzYhv61piNY">https://www.youtube.com/watch?v=tzYhv61piNY</a></li><li>Python virtual machine: <a href=https://www.ics.uci.edu/~brgallar/week9_3.html>https://www.ics.uci.edu/~brgallar/week9_3.html</a></li><li>python bytecode<ul><li><a href="https://www.youtube.com/watch?v=cSSpnq362Bk">https://www.youtube.com/watch?v=cSSpnq362Bk</a></li><li><a href=https://nedbatchelder.com/blog/201803/is_python_interpreted_or_compiled_yes.html>https://nedbatchelder.com/blog/201803/is_python_interpreted_or_compiled_yes.html</a></li></ul></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>jdhao</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2021-03-15</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><nav class=post-nav><a class=prev href=/2021/03/16/std_stream_buffering_in_python/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">print message not shown in nohup.out?</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/2021/03/07/how_to_make_la_zhi_rou/><span class="next-text nav-default">腊汁肉制作</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=jdhao/jdhao.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:jdhao@hotmail.com class="iconfont icon-email" title=email></a><a href="https://stackoverflow.com/users/6064933/jdhao?tab=profile" class="iconfont icon-stack-overflow" title=stack-overflow></a><a href=https://github.com/jdhao class="iconfont icon-github" title=github></a><a href=https://jdhao.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>site pv: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> </span><span class=division>|</span>
<span id=busuanzi_container_site_uv>site uv: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span></span></div><span class=copyright-year>&copy;
2017 -
2024<span class=heart><i class="iconfont icon-heart"></i></span><span>jdhao</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script><script type=text/javascript>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-113395108-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>