<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Learning Expect Programming - Blowfish</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="jdhao"><meta name=description content="In my previous post, I talked about how to automate the server login process with the help of Expect programming language. This post continues my learning process.
"><meta name=generator content="Hugo 0.123.8 with theme even"><link rel=canonical href=https://jdhao.github.io/2019/10/29/expect_script_learning/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6058871559165202",enable_page_level_ads:!0})</script><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><meta property="og:title" content="Learning Expect Programming"><meta property="og:description" content="In my previous post,
I talked about how to automate the server login process with the help of Expect
programming language. This post continues my learning process."><meta property="og:type" content="article"><meta property="og:url" content="https://jdhao.github.io/2019/10/29/expect_script_learning/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-29T01:42:59+08:00"><meta property="article:modified_time" content="2020-03-30T16:15:48+02:00"><meta itemprop=name content="Learning Expect Programming"><meta itemprop=description content="In my previous post,
I talked about how to automate the server login process with the help of Expect
programming language. This post continues my learning process."><meta itemprop=datePublished content="2019-10-29T01:42:59+08:00"><meta itemprop=dateModified content="2020-03-30T16:15:48+02:00"><meta itemprop=wordCount content="978"><meta itemprop=keywords content="Expect,Regex,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Learning Expect Programming"><meta name=twitter:description content="In my previous post,
I talked about how to automate the server login process with the help of Expect
programming language. This post continues my learning process."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Blowfish</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/posts/><li class=mobile-menu-item>Archives</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Blowfish</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/posts/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><div class=post-content><p>In <a href=https://jdhao.github.io/2018/10/08/server_autologin_with_expect/>my previous post</a>,
I talked about how to automate the server login process with the help of Expect
programming language. This post continues my learning process.</p><h1 id=difference-between-send-and-send_user-command>Difference between <code>send</code> and <code>send_user</code> command?</h1><p>There are two similar commands in Expect, <code>send</code> and <code>send_user</code>. <code>send</code> and
<code>send_user</code> have different purposes. <code>send</code> is used to provide input for the
spawned processes, while <code>send_user</code> is used to send some message to via
terminal to the users.</p><h1 id=difference-between-n-and-r-in-expect>Difference between <code>\n</code> and <code>\r</code> in Expect?</h1><p>According to my test, when you use <code>send</code> to send characters to the spawned
process, it makes no difference to use either <code>\r</code> (carriage return) or <code>\n</code>
(line feed). They both works as if the user has press the <kbd>Enter</kbd> key.</p><p>However, they work differently when you want use <code>send_user</code> to display
something to the user. <code>\n</code> will give a new line while <code>\r</code> will just move the
cursor to the beginning of the line (i.e., your message will be erased). To
verify, execute the following command</p><pre tabindex=0><code class=language-expect data-lang=expect>expect {
    &#34;prompt1&#34; {send_user &#34;answer1\n&#34;}
    &#34;prompt2&#34; {send_user &#34;answer2\r&#34;}
}
</code></pre><p>If you execute the above script with expect, when you input <code>prompt1</code>, you will
get the output <code>answer1</code> and a new line is started; when you input <code>prompt2</code>,
you get nothing in the screen. Actually, <code>answer2</code> is shown and is then erased
by <code>\r</code>.</p><h1 id=check-if-a-file-exists>Check if a file exists</h1><p>Sometimes, we may want to check if a file exists and take some actions based on
the condition. We use <a href=http://tcl.tk/man/tcl8.5/TclCmd/file.htm#M15><code>file exists &lt;name></code></a> to check that:</p><pre tabindex=0><code class=language-expect data-lang=expect>if {[file exists .ssh/known_hosts]} {
    spawn rm .ssh/known_hosts
}
</code></pre><h1 id=match-optional-prompts>Match optional prompts</h1><p>Sometimes, there are optional prompts which may occur depending on some
conditions. For example, when we first log into a new server, we are warned
that the authenticity of the server can not be established and if we want to
continue connecting. After that, we may not see this prompt anymore. We can use
the <code>exp_continue</code> command to achieve that.</p><pre tabindex=0><code class=language-expect data-lang=expect>expect {
    &#34;Are you sure*&#34; {
        send &#34;yes\r&#34;
        exp_continue
    }
    &#34;*password: &#34; {
        send &#34;pass\r&#34;
    }
}
</code></pre><p>The <code>exp_continue</code> command will continue the expect block until it matches
another pattern or timeouts.</p><h1 id=pattern-matching>Pattern matching</h1><h2 id=double-quotes-and-curly-braces-in-pattern-matching>Double quotes and curly braces in pattern matching</h2><p>In expect script, both double quotes and curly braces can be used to group
argument. They are quite different.</p><p>Inside double quotes, variable substitution and command substitution and
backslash substitution take place:</p><ul><li>variable substitution: <code>$var</code> will be replaced with actual value of variable <code>var</code>.</li><li>command substitution: <code>[some_char]</code> is considered as command invoking, and
he result of executing command <code>some_char</code> replaces <code>[some_char]</code>. Also see
<a href=https://www.tcl.tk/man/tcl8.5/tutorial/Tcl5.html>this guide page.</a></li><li>backslash substitution: characters after <code>\</code> is replaced with the character
verbatim. There are several exceptions to this rule. For example, <code>\n</code>, <code>\t</code>,
<code>\uHHHH</code> etc. have special meanings. For a complete list, see <a href=https://wiki.tcl-lang.org/page/Dodekalogue>this
page</a> (the part about backslash
substitution).</li></ul><p>Inside double braces, command substitution, variable expansion and backslash
substitution does not take place. For example:</p><pre tabindex=0><code>expect {
    # match $var literally
    {$var} {send_user &#34;yes\n&#34;}
    # match character \ and $
    {\$} {send_user &#34;yes\n&#34;}
    # match character \ and n
    {\n} {send_user &#34;yes\n&#34;}
}
</code></pre><h2 id=glob-match-patterns>Glob match patterns</h2><p>For simple matching, glob patterns can be used, and it works similarly to the
bash glob functionality. <code>*</code> is used to represent any number of characters, and
<code>?</code> is used to represent a single character. For more info about glob patterns,
see <a href=https://www.tcl.tk/man/tcl8.5/tutorial/Tcl16a.html>doc here</a>.</p><p>Some patterns and their meanings are listed below:</p><pre tabindex=0><code>expect{
    # match strings containing abc
    expect *abc*
    # match literal [a]
    {\[a]} {send_user &#34;yes\n&#34;}
    # match literal [a]
    {\[a\]} {send_user &#34;yes\n&#34;}
    # match strings containing ab followed by another character
    {ab?} {send_user &#34;yes\n&#34;}
    # match `abc` or `abd`
    {ab[cd]} {send_user &#34;yes\n&#34;}
}
</code></pre><h2 id=regex-matching>Regex matching</h2><p>If you want to match more complex patterns, you can also use the <a href=http://www.tcl.tk/man/tcl8.5/TclCmd/re_syntax.htm#M66>regex
provided by the Tcl
language</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. To use
regex, you will use the <code>-re</code> option for <code>expect</code> command. For example, to
match either <code>ab</code> or <code>cd</code>, you can use the following command:</p><pre tabindex=0><code>expect -re ab|cd {send_user &#34;hello\n&#34;}
</code></pre><p>As discussed before, since patterns inside the double quotes undergo several
substitutions, you should take extra care when you want to match patterns using
regex. For example, to match consecutive digits, you should use <code>expect -re "\\d+"</code> or <code>expect -re {\d+}</code>. If you use <code>expect -re "\d+"</code>, you will match
consecutive character<code>d</code> since backslash will translate <code>\d</code> inside double
quotes.</p><pre tabindex=0><code> expect {
    # the following two patterns both match two consecutive alphabet chars.
    -re &#34;\[a-z\]{2}&#34; {send_user &#34;yes\n&#34;}
    -re {[a-z]{2}} {send_user &#34;yes\n&#34;}
    # match a lenth 2 string which contains only alpha-numerical chars.
    -re {^[a-z0-9]{2}\n$} {send_user &#34;yes\n&#34;}
    timeout {send_user &#34;time out\n&#34;}
 }
</code></pre><h2 id=matching-bracket-literally>Matching bracket literally</h2><p>One extremely complex and bewildering pattern is to match square bracket
literally. It is difficult because square bracket have special meanings in both
command substitution and in regex or glob pattern.</p><p>If you use double quotes, in order to match <code>[a]</code> literally, you have to use
triple backslash to escape it:</p><pre tabindex=0><code>expect -re &#34;\\\[a\\\]&#34; {send_user &#34;yes\n&#34;}
# or you can use
expect &#34;\\\[a\\\]&#34; {send_user &#34;yes\n&#34;}
</code></pre><p>First backslash is to prevent command substitution. Second backslash and third
backslash is to prevent backslash substitution so that regex engine can see one
backslash. So the final pattern regex engine sees is actually <code>\[a\]</code>, which
prevents a from being interpreted as a regex range. Thus, it is matched
literally. <a href=https://www.tcl.tk/man/tcl8.5/tutorial/Tcl21.html>This page</a> also
explains why three backslashes are needed in order to match literal square
bracket if we use double quotes.</p><p>To prevent such complex patterns, it is highly encouraged to use double braces
to simplify the pattern. The above pattern can be simplified as the following:</p><pre tabindex=0><code class=language-expect data-lang=expect>expect {
    {\[a\]} {send_user &#34;yes\n&#34;}
}
</code></pre><h1 id=references>References</h1><ul><li><a href=https://stackoverflow.com/questions/23909157/how-to-find-if-a-file-exists-in-expect-script>Expect check if file exists.</a></li><li><a href=https://stackoverflow.com/a/52893825/6064933>Expect: match optional prompt.</a></li><li><a href=https://stackoverflow.com/a/26187389/6064933>Difference between <code>\r</code> and <code>\n</code> in expect.</a></li><li><a href=https://stackoverflow.com/questions/17064555/using-regular-expressions-with-expect>Expect regex</a></li><li><a href=https://www.oreilly.com/library/view/exploring-expect/9781565920903/ch04.html>Expect glob and other patterns</a></li><li><a href=http://www.tcl.tk/man/tcl8.5/TclCmd/re_syntax.htm#M66>Tcl regex syntax references.</a></li><li><a href=https://www.tcl.tk/man/tcl8.5/tutorial/Tcl3.html>Grouping with double quotes.</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>expect language is an extension to the Tcl programming language.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=https://jdhao.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
-
2024<span class=heart><i class="iconfont icon-heart"></i></span><span>jdhao</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script></body></html>