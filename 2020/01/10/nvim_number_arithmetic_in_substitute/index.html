<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Doing Number Arithmetics in Vim/Neovim Substitutions - jdhao's digital space</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="jdhao"><meta name=description content="In this post, I want to share how to do number arithmetic quickly and get what you want in specified format. More specifically, the topic is:
How do we add, subtract, multiply or divide a value to each number in a range?
"><meta name=keywords content="Hugo,theme,even"><meta name=google-site-verification content="HTz0VHxqny_b0FfS774dICLBzHGBZCb_S11j_akF1Tw"><meta name=generator content="Hugo 0.105.0 with theme even"><link rel=canonical href=https://jdhao.github.io/2020/01/10/nvim_number_arithmetic_in_substitute/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-6058871559165202",enable_page_level_ads:!0})</script><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Doing Number Arithmetics in Vim/Neovim Substitutions"><meta property="og:description" content="In this post, I want to share how to do number arithmetic quickly and get what
you want in specified format. More specifically, the topic is:

How do we add, subtract, multiply or divide a value to each number in a
range?
"><meta property="og:type" content="article"><meta property="og:url" content="https://jdhao.github.io/2020/01/10/nvim_number_arithmetic_in_substitute/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-01-10T23:48:25+08:00"><meta property="article:modified_time" content="2020-12-08T17:05:22+01:00"><meta itemprop=name content="Doing Number Arithmetics in Vim/Neovim Substitutions"><meta itemprop=description content="In this post, I want to share how to do number arithmetic quickly and get what
you want in specified format. More specifically, the topic is:

How do we add, subtract, multiply or divide a value to each number in a
range?
"><meta itemprop=datePublished content="2020-01-10T23:48:25+08:00"><meta itemprop=dateModified content="2020-12-08T17:05:22+01:00"><meta itemprop=wordCount content="743"><meta itemprop=keywords content="Vim,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Doing Number Arithmetics in Vim/Neovim Substitutions"><meta name=twitter:description content="In this post, I want to share how to do number arithmetic quickly and get what
you want in specified format. More specifically, the topic is:

How do we add, subtract, multiply or divide a value to each number in a
range?
"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>jdhao's digital space</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>jdhao's digital space</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Doing Number Arithmetics in Vim/Neovim Substitutions</h1><div class=post-meta><span class=post-time>2020-01-10</span><div class=post-category><a href=/categories/Nvim/>Nvim</a></div><span class=more-meta>743 words</span>
<span class=more-meta>4 mins read</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> times read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#example-1>Example 1</a></li><li><a href=#example-2>Example 2</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p>In this post, I want to share how to do number arithmetic quickly and get what
you want in specified format. More specifically, the topic is:</p><blockquote><p>How do we add, subtract, multiply or divide a value to each number in a
range?</p></blockquote><h1 id=example-1>Example 1</h1><p>Suppose that we have the following numbers at the end of each line:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>line 1: 10
</span></span><span class=line><span class=cl>line 2: 20
</span></span><span class=line><span class=cl>line 3: 30
</span></span><span class=line><span class=cl>line 4: 40
</span></span><span class=line><span class=cl>line 5: 50
</span></span></code></pre></div><p>How to we do arithmetic operation to those numbers at the end of each line
quickly?</p><p>We can use expression in substitution command to do this task, for details, see
<code>:h sub-replace-expression</code> inside Vim. The idea is that instead of substitute
what you search with a string, we will evaluate an expression and use the
evaluated result as the replace string. The general syntax for substitution is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:s/PATTERN/REPLACE/[flag]
</span></span></code></pre></div><p>To use an expression in REPLACE string, you can start the replacement string
with <code>\=</code>, and the following string will be interpreted as an expression by
Vim. If you have used capture groups in <code>PATTERN</code>, you can retrieve the
captured text in the corresponding capture group with <code>submatch()</code> function.
For example, <code>submatch(1)</code> will return the text in the 1st capture group,
<code>submatch(2)</code> returns the 2nd group, <code>submatch(0)</code> will return the whole
matching pattern.</p><p>With all this knowledge, we can easily solve the above problem. For example, to
add 2 to the number at the end of each line, do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=p>:</span><span class=m>1</span><span class=p>,</span><span class=m>5</span>s<span class=sr>/\v(\d+)$/</span>\<span class=p>=</span><span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))+</span><span class=m>2</span><span class=err>
</span></span></span></code></pre></div><p>Note that in the above command, the return value of <code>submatch()</code> are strings.
In order to convert string to float type, we need to use function <code>str2float()</code>
explicitly. Although you can directly add strings with numbers, the result may
not be what you want. For example, <code>echo '0.2' + 2</code> shows 2 instead of 2.2.
After looking at the documentation on variables (<code>:h variables</code>), I find the
the reason:</p><blockquote><p>The Number and String types are converted automatically, depending on how they are used.</p></blockquote><p>It means that strings will by default be converted to an integer where
necessary. So string <code>0.2</code> becomes 0 when we add it with 2.</p><p>Similarly, to minus or multiply by 2:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=p>:</span><span class=m>1</span><span class=p>,</span><span class=m>5</span>s<span class=sr>/\v(\d+)$/</span>\<span class=p>=</span><span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))</span><span class=m>-2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>:</span><span class=m>1</span><span class=p>,</span><span class=m>5</span>s<span class=sr>/\v(\d+)$/</span>\<span class=p>=</span><span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>*<span class=m>2</span><span class=err>
</span></span></span></code></pre></div><p>For division, things are a little different here, because the division
symbol <code>/</code> is the same as the substitute delimiter. In order to use division
character in substitute expression, we can <a href=https://stackoverflow.com/q/11823616/6064933>change the delimiter to other
characters</a>, for example, to <code>#</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=p>:</span><span class=m>1</span><span class=p>,</span><span class=m>5</span>s#\<span class=nx>v</span><span class=p>(</span>\<span class=nx>d</span><span class=p>+)</span>$#\<span class=p>=</span><span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>/<span class=m>2</span>.<span class=m>0</span><span class=err>
</span></span></span></code></pre></div><p>Note that for division, we need to divide those numbers by 2.0, not by 2. If
you use two integers, Vim will use integer division, not float division<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>One minor issue with the division result is that the result may have many
decimal digits. You may want to round it to fixed digit, e.g., 3 digits. This
can be easily accomplished with the <code>printf()</code> function, and the whole command
looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=p>:</span><span class=m>1</span><span class=p>,</span><span class=m>5</span>s#\<span class=nx>v</span><span class=p>(</span>\<span class=nx>d</span><span class=p>+)</span>$#\<span class=p>=</span><span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;%.3f&#39;</span><span class=p>,</span> <span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))</span>/<span class=m>2</span>.<span class=m>3</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><h1 id=example-2>Example 2</h1><p>I have the following 4 columns of text (separated by more than one spaces):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>data1     data2    data3       data4
</span></span><span class=line><span class=cl>12         1.0     0.1667 in   0.2150 in
</span></span><span class=line><span class=cl>16         1.0     0.2222 in   0.2825 in
</span></span><span class=line><span class=cl>20         1.0     0.2778 in   0.3488 in
</span></span><span class=line><span class=cl>24         1.0     0.3333 in   0.4163 in
</span></span><span class=line><span class=cl>28         1.0     0.3889 in   0.4838 in
</span></span><span class=line><span class=cl>32         1.0     0.4444 in   0.5513 in
</span></span></code></pre></div><p>I want to insert the result of division from 4th and 3rd column in the end of
each line. For example, after insertion, first line will become:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12          1.0     0.1667 in   0.2150 in       1.2897
</span></span></code></pre></div><p>My initial implementation is like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=nx>s</span>#\<span class=nx>v</span>\<span class=nx>d</span>{<span class=m>2</span><span class=p>,</span>}\<span class=nx>s</span><span class=p>+</span>\<span class=nx>d</span>\.\<span class=nx>d</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.<span class=p>+</span>\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>#\<span class=p>=</span><span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;%s  %.4f&#39;</span><span class=p>,</span> <span class=nx>submatch</span><span class=p>(</span><span class=m>0</span><span class=p>),</span> <span class=nx>submatch</span><span class=p>(</span><span class=m>2</span><span class=p>)</span>/<span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>))</span><span class=err>
</span></span></span></code></pre></div><p>However, I am getting the following result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12          1.0     0.1667 in   0.2150 in  -9223372036854775808.0000
</span></span></code></pre></div><p>It seems that the number division goes wrong for string types.</p><p>As discussed earlier, <code>submatch()</code> returns a string and string will be
converted to integer implicitly when doing arithematics. So these two strings
are converted to integer instead of float type, and they all become 0, as can
be verifed by the command: <code>echo 0/0</code>.</p><p>We need to convert these strings into float first. The correct command is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=nx>s</span>#\<span class=nx>v</span>\<span class=nx>d</span>{<span class=m>2</span><span class=p>,</span>}\<span class=nx>s</span><span class=p>+</span>\<span class=nx>d</span>\.\<span class=nx>d</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.<span class=p>+</span>\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>#\<span class=p>=</span><span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;%s  %.4f&#39;</span><span class=p>,</span> <span class=nx>submatch</span><span class=p>(</span><span class=m>0</span><span class=p>),</span> <span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>2</span><span class=p>))</span>/<span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>)))</span><span class=err>
</span></span></span></code></pre></div><p>We can also use <code>\zs</code> to simplify the above command a bit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=line><span class=cl><span class=nx>s</span>#\<span class=nx>v</span>\<span class=nx>d</span>{<span class=m>2</span><span class=p>,</span>}\<span class=nx>s</span><span class=p>+</span>\<span class=nx>d</span>\.\<span class=nx>d</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>\<span class=nx>s</span><span class=p>+(</span>\<span class=nx>d</span>\.<span class=p>+</span>\<span class=nx>d</span><span class=p>+)</span> <span class=nx>in</span>\<span class=nx>zs</span>.*#\<span class=p>=</span><span class=nx>printf</span><span class=p>(</span><span class=s1>&#39;  %.4f&#39;</span><span class=p>,</span> <span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>2</span><span class=p>))</span>/<span class=nx>str2float</span><span class=p>(</span><span class=nx>submatch</span><span class=p>(</span><span class=m>1</span><span class=p>)))</span><span class=err>
</span></span></span></code></pre></div><h1 id=references>References</h1><ul><li><a href=https://stackoverflow.com/a/18400233/6064933>Number manipulation within Vim.</a></li><li><a href=https://stackoverflow.com/a/1684651/6064933>Change delimiter in search and replace command.</a></li><li><a href=https://vi.stackexchange.com/q/22469/15292>Increment a specific number in csv file.</a></li><li><a href=https://stackoverflow.com/a/5202066/6064933>Rounding number in Vim.</a></li><li><a href=https://stackoverflow.com/a/32042050/6064933>Round floats to one decimal.</a></li><li><a href=https://stackoverflow.com/q/37805433/6064933>vim substitution with mathematical expression</a></li><li><a href=https://stackoverflow.com/a/26387821/6064933>How can I convert px units to em units programmatically in vim?</a></li><li><a href=https://vi.stackexchange.com/q/17934/15292>Search and replace: float arithmetic</a></li><li><a href=https://learnvimscriptthehardway.stevelosh.com/chapters/25.html>https://learnvimscriptthehardway.stevelosh.com/chapters/25.html</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>For example, if we do <code>:echo 5/2</code>, we will get <code>2</code> instead of <code>2.5</code>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>jdhao</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-12-08</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/Vim/>Vim</a></div><nav class=post-nav><a class=prev href=/2020/01/11/my_reading_list_2019/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">我的 2019 阅读清单</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/2020/01/05/ultisnips_python_interpolation/><span class="next-text nav-default">Regex Keyword and Python Interpolation in Ultisnips</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=jdhao/jdhao.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:jdhao@hotmail.com class="iconfont icon-email" title=email></a>
<a href="https://stackoverflow.com/users/6064933/jdhao?tab=profile" class="iconfont icon-stack-overflow" title=stack-overflow></a>
<a href=https://github.com/jdhao class="iconfont icon-github" title=github></a>
<a href=https://jdhao.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>site pv: <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span></span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>site uv: <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span></span></div><span class=copyright-year>&copy;
2017 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>jdhao</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-113395108-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>